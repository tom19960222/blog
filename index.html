<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.3.0/css/all.min.css" integrity="sha256-/4UQcSmErDzPCMAiuOiWPVVsNN2s3ZY/NsmXNcj0IFc=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"blog.yeekaros.net","root":"/","images":"/images","scheme":"Gemini","darkmode":true,"version":"8.15.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜尋...","empty":"我們無法找到任何有關 ${query} 的搜索結果","hits_time":"${hits} 找到 ${time} 個結果","hits":"找到 ${hits} 個結果"}}</script><script src="/js/config.js"></script>

    <meta name="description" content="一個肥宅工程師的碎碎念">
<meta property="og:type" content="website">
<meta property="og:title" content="爆頭的隨手記">
<meta property="og:url" content="https://blog.yeekaros.net/index.html">
<meta property="og:site_name" content="爆頭的隨手記">
<meta property="og:description" content="一個肥宅工程師的碎碎念">
<meta property="og:locale" content="zh_TW">
<meta property="article:author" content="YEEKaros">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://blog.yeekaros.net/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-TW","comments":"","permalink":"","path":"index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>爆頭的隨手記</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切換導航欄" role="button">
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">爆頭的隨手記</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜尋" role="button">
    </div>
  </div>
</div>







</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目錄
        </li>
        <li class="sidebar-nav-overview">
          本站概要
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">YEEKaros</p>
  <div class="site-description" itemprop="description">一個肥宅工程師的碎碎念</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">4</span>
          <span class="site-state-item-name">文章</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">3</span>
        <span class="site-state-item-name">標籤</span>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://blog.yeekaros.net/2022/10/15/AWS-%E5%8F%B0%E7%81%A3-local-zone-%E8%B7%AF%E7%94%B1%E6%B8%AC%E8%A9%A6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="YEEKaros">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="爆頭的隨手記">
      <meta itemprop="description" content="一個肥宅工程師的碎碎念">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 爆頭的隨手記">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/10/15/AWS-%E5%8F%B0%E7%81%A3-local-zone-%E8%B7%AF%E7%94%B1%E6%B8%AC%E8%A9%A6/" class="post-title-link" itemprop="url">AWS 台灣 local zone 路由測試</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">發表於</span>

      <time title="創建時間：2022-10-15 16:49:16" itemprop="dateCreated datePublished" datetime="2022-10-15T16:49:16+08:00">2022-10-15</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新於</span>
      <time title="修改時間：2023-03-04 22:27:16" itemprop="dateModified" datetime="2023-03-04T22:27:16+08:00">2023-03-04</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>其實這篇的內容早在 10&#x2F;6 就已經測完了，只是一直懶得動筆紀錄一下 Orz</p>
<p>先前就一直有聽說 AWS 有要開台灣區的意願，終於在 10&#x2F;6 看到 gslin 大大貼的 <a target="_blank" rel="noopener" href="https://blog.gslin.org/archives/2022/10/06/10903/aws-%e7%9a%84%e5%8f%b0%e5%8c%97%e5%8d%80-local-zone-%e9%96%8b%e4%ba%86/">AWS 的台北區 (Local Zone) 開了</a>，那當然要趕快來玩玩看啦</p>
<p>經過測試確實和 gslin 的另一篇 <a target="_blank" rel="noopener" href="https://blog.gslin.org/archives/2022/10/06/10905/%e7%9b%ae%e5%89%8d-aws-%e5%8f%b0%e5%8c%97%e5%8d%80%e5%8f%aa%e8%83%bd%e9%96%8b-2xlarge-%e7%9a%84%e6%a9%9f%e5%99%a8/">目前 AWS 台北區只能開 *.2xlarge 的機器</a> 一樣，目前只能開 2xlarge 的機器還不能開 spot instance，所以就開了一台 <code>m5.2xlarge</code> 來玩玩看，價格是 $0.62 USD&#x2F;hour</p>
<p>因為公司有網路電話相關的業務放在 Cloud 上，SIP protocol 對延遲和掉包又比較敏感，當初也是因為這點才棄 AWS 改用 GCP 台灣區。這次就來簡單測試一下島內和國際路由吧！</p>
<p>本次開出來的機器 IP 是 <code>15.220.83.12</code>，從 <a target="_blank" rel="noopener" href="https://bgp.he.net/ip/15.220.83.12">bgp.he.net</a> 來看，IP 段應該都在 <code>15.220.80.0/20</code> 內。</p>
<h1 id="測試結果"><a href="#測試結果" class="headerlink" title="測試結果"></a>測試結果</h1><p>分成島內家用&#x2F;商用固網、商業服務、國際和自己在玩的自有 IP 相關的測試</p>
<h2 id="島內家用-x2F-商用固網"><a href="#島內家用-x2F-商用固網" class="headerlink" title="島內家用&#x2F;商用固網"></a>島內家用&#x2F;商用固網</h2><h3 id="中華非固定制-500M-x2F-250M"><a href="#中華非固定制-500M-x2F-250M" class="headerlink" title="中華非固定制 500M&#x2F;250M"></a>中華非固定制 500M&#x2F;250M</h3><p><img src="/2022/10/15/AWS-%E5%8F%B0%E7%81%A3-local-zone-%E8%B7%AF%E7%94%B1%E6%B8%AC%E8%A9%A6/%E5%88%B0%E4%B8%AD%E8%8F%AF%E9%9D%9E%E5%9B%BA%E5%AE%9A%E5%88%B6.png" alt="到中華非固定制" loading="lazy"><br><img src="/2022/10/15/AWS-%E5%8F%B0%E7%81%A3-local-zone-%E8%B7%AF%E7%94%B1%E6%B8%AC%E8%A9%A6/%E5%BE%9E%E4%B8%AD%E8%8F%AF%E9%9D%9E%E5%9B%BA%E5%AE%9A%E5%88%B6.png" alt="從中華非固定制" loading="lazy"></p>
<h3 id="中華固定制-500M-x2F-250M"><a href="#中華固定制-500M-x2F-250M" class="headerlink" title="中華固定制 500M&#x2F;250M"></a>中華固定制 500M&#x2F;250M</h3><p><img src="/2022/10/15/AWS-%E5%8F%B0%E7%81%A3-local-zone-%E8%B7%AF%E7%94%B1%E6%B8%AC%E8%A9%A6/%E5%88%B0%E4%B8%AD%E8%8F%AF%E5%9B%BA%E5%AE%9A%E5%88%B6.png" alt="到中華固定制" loading="lazy"><br><img src="/2022/10/15/AWS-%E5%8F%B0%E7%81%A3-local-zone-%E8%B7%AF%E7%94%B1%E6%B8%AC%E8%A9%A6/%E5%BE%9E%E4%B8%AD%E8%8F%AF%E5%9B%BA%E5%AE%9A%E5%88%B6.png" alt="從中華固定制" loading="lazy"></p>
<p>固定制和非固定制的表現差不多，可以很明顯的看出這次 local zone 的機房是<a target="_blank" rel="noopener" href="https://goo.gl/maps/ExigwJCmFcdv87Qq9">中華板橋 IDC</a></p>
<h3 id="遠傳固定制-off-net-100M-x2F-100M"><a href="#遠傳固定制-off-net-100M-x2F-100M" class="headerlink" title="遠傳固定制 off-net 100M&#x2F;100M"></a>遠傳固定制 off-net 100M&#x2F;100M</h3><p><img src="/2022/10/15/AWS-%E5%8F%B0%E7%81%A3-local-zone-%E8%B7%AF%E7%94%B1%E6%B8%AC%E8%A9%A6/%E5%88%B0%E9%81%A0%E5%82%B3off-net.png" alt="到遠傳 off-net" loading="lazy"><br><img src="/2022/10/15/AWS-%E5%8F%B0%E7%81%A3-local-zone-%E8%B7%AF%E7%94%B1%E6%B8%AC%E8%A9%A6/%E5%BE%9E%E9%81%A0%E5%82%B3off-net.png" alt="從遠傳 off-net" loading="lazy"></p>
<h3 id="板橋大大寬頻-亞太出口-360M-x2F-120M"><a href="#板橋大大寬頻-亞太出口-360M-x2F-120M" class="headerlink" title="板橋大大寬頻 亞太出口 360M&#x2F;120M"></a>板橋大大寬頻 亞太出口 360M&#x2F;120M</h3><p><img src="/2022/10/15/AWS-%E5%8F%B0%E7%81%A3-local-zone-%E8%B7%AF%E7%94%B1%E6%B8%AC%E8%A9%A6/%E5%88%B0%E6%9D%BF%E6%A9%8B%E5%A4%A7%E5%A4%A7%E5%AF%AC%E9%A0%BB.png" alt="到板橋大大寬頻" loading="lazy"><br><img src="/2022/10/15/AWS-%E5%8F%B0%E7%81%A3-local-zone-%E8%B7%AF%E7%94%B1%E6%B8%AC%E8%A9%A6/%E5%BE%9E%E6%9D%BF%E6%A9%8B%E5%A4%A7%E5%A4%A7%E5%AF%AC%E9%A0%BB.png" alt="從板橋大大寬頻" loading="lazy"></p>
<p>個人猜測 AWS 和中華、遠傳都有 PNI，和亞太則是透過 <code>EBIX</code> peer。不過 <code>EBIX</code> 也是亞太自家的，某種意義上也是和亞太直接接了條線了啦 (?)</p>
<h2 id="商業服務"><a href="#商業服務" class="headerlink" title="商業服務"></a>商業服務</h2><h3 id="Cloudflare-DNS"><a href="#Cloudflare-DNS" class="headerlink" title="Cloudflare DNS"></a>Cloudflare DNS</h3><p>毫不意外的直連</p>
<p><del>只有中華才會死不跟你在台灣  peer 啦</del></p>
<p><img src="/2022/10/15/AWS-%E5%8F%B0%E7%81%A3-local-zone-%E8%B7%AF%E7%94%B1%E6%B8%AC%E8%A9%A6/%E5%88%B0cloudflare-dns.png" alt="到cloudflare-dns" loading="lazy"></p>
<h3 id="遠傳-SIP-gateway"><a href="#遠傳-SIP-gateway" class="headerlink" title="遠傳 SIP gateway"></a>遠傳 SIP gateway</h3><p>比較意外的是竟然是走中華到遠傳，不過延遲看起來沒啥問題，真的有需要或是有差的話不知道可不可以請他們調整路由?</p>
<p><img src="/2022/10/15/AWS-%E5%8F%B0%E7%81%A3-local-zone-%E8%B7%AF%E7%94%B1%E6%B8%AC%E8%A9%A6/%E5%88%B0%E9%81%A0%E5%82%B3SIP-gateway.png" alt="到遠傳SIP-gateway" loading="lazy"></p>
<h2 id="國際"><a href="#國際" class="headerlink" title="國際"></a>國際</h2><h3 id="Vultr-日本"><a href="#Vultr-日本" class="headerlink" title="Vultr 日本"></a>Vultr 日本</h3><p>當時忘了多測一些服務了，只記得測了 Vultr 日本區，就加減看看吧</p>
<p><img src="/2022/10/15/AWS-%E5%8F%B0%E7%81%A3-local-zone-%E8%B7%AF%E7%94%B1%E6%B8%AC%E8%A9%A6/%E5%88%B0Vultr%E6%97%A5%E6%9C%AC.png" alt="到Vultr日本" loading="lazy"><br><img src="/2022/10/15/AWS-%E5%8F%B0%E7%81%A3-local-zone-%E8%B7%AF%E7%94%B1%E6%B8%AC%E8%A9%A6/%E5%BE%9EVultr%E6%97%A5%E6%9C%AC.png" alt="從Vultr日本" loading="lazy"></p>
<p>看起來到日本是走 <code>PCCW</code>，算是優質的 T1 ISP，<del>總比 174 好了</del></p>
<h2 id="自有-IP-相關"><a href="#自有-IP-相關" class="headerlink" title="自有 IP 相關"></a>自有 IP 相關</h2><p>順便幫忙宣傳一下，如果對擁有一段自己的 IP 有興趣，或是想要跟 AWS、Cloudflare、HE 接 direct peering 的，可以支持一下<a target="_blank" rel="noopener" href="https://seadog007.me/">海豹 (@seadog007)</a> 的 <a target="_blank" rel="noopener" href="https://stuix.io/">學生聯合交換中心 (STUIX)</a> 計畫，群裡也有 LIR 大佬們可以幫忙申請 ASN 和 IP，如有需要歡迎聯繫。</p>
<h3 id="STUIX-VPS"><a href="#STUIX-VPS" class="headerlink" title="STUIX VPS"></a>STUIX VPS</h3><p><img src="/2022/10/15/AWS-%E5%8F%B0%E7%81%A3-local-zone-%E8%B7%AF%E7%94%B1%E6%B8%AC%E8%A9%A6/%E5%88%B0STUIX-VPS.png" alt="到STUIX-VPS" loading="lazy"><br><img src="/2022/10/15/AWS-%E5%8F%B0%E7%81%A3-local-zone-%E8%B7%AF%E7%94%B1%E6%B8%AC%E8%A9%A6/%E5%BE%9ESTUIX-VPS.png" alt="從STUIX-VPS" loading="lazy"></p>
<p>多虧 AWS 有接入 STUIX，基本上就是實體線路直接對接的延遲</p>
<h3 id="自家-IP-台北"><a href="#自家-IP-台北" class="headerlink" title="自家 IP (台北)"></a>自家 IP (台北)</h3><p><img src="/2022/10/15/AWS-%E5%8F%B0%E7%81%A3-local-zone-%E8%B7%AF%E7%94%B1%E6%B8%AC%E8%A9%A6/%E5%88%B0%E5%AE%B6%E8%A3%A1-public-ip.png" alt="到家裡-public-ip" loading="lazy"></p>
<p>我自己沒有跟 AWS direct peer，不過感謝海豹幫我 transit 了。</p>
<p><del>雖然我自己的內網路由很明顯噴到國外再噴回來了，有空再來修</del></p>
<h3 id="自家-IP-日本"><a href="#自家-IP-日本" class="headerlink" title="自家 IP (日本)"></a>自家 IP (日本)</h3><p><img src="/2022/10/15/AWS-%E5%8F%B0%E7%81%A3-local-zone-%E8%B7%AF%E7%94%B1%E6%B8%AC%E8%A9%A6/%E5%88%B0Vultr%E6%97%A5%E6%9C%ACpublic-ip.png" alt="到Vultr日本public-ip" loading="lazy"><br><img src="/2022/10/15/AWS-%E5%8F%B0%E7%81%A3-local-zone-%E8%B7%AF%E7%94%B1%E6%B8%AC%E8%A9%A6/%E5%BE%9EVultr%E6%97%A5%E6%9C%ACpublic-ip.png" alt="從Vultr日本public-ip" loading="lazy"></p>
<p>去程一樣是走 STUIX 到我的自有 IP，<del>回程則是走 Vultr -&gt; JPIX 到 AWS</del></p>
<p>發現回程因為我自己網路炸了所以根本是走 Vultr 的 IP 出去的，<del>一樣有空再修吧，看起來又可以再來重蓋網路了</del></p>
<h1 id="總結"><a href="#總結" class="headerlink" title="總結"></a>總結</h1><p>目前整體來說除了只能開 <code>2xlarge</code> 的機器以外沒啥好挑剔的，坐等台灣區從 local zone 晉升到 region 的那天 ヽ（。∀°）ノ</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://blog.yeekaros.net/2022/09/02/OpenVPN-%E6%87%B6%E4%BA%BA%E5%AE%89%E8%A3%9D%E6%B3%95/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="YEEKaros">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="爆頭的隨手記">
      <meta itemprop="description" content="一個肥宅工程師的碎碎念">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 爆頭的隨手記">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/09/02/OpenVPN-%E6%87%B6%E4%BA%BA%E5%AE%89%E8%A3%9D%E6%B3%95/" class="post-title-link" itemprop="url">OpenVPN 懶人安裝法</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">發表於</span>

      <time title="創建時間：2022-09-03 01:37:31" itemprop="dateCreated datePublished" datetime="2022-09-03T01:37:31+08:00">2022-09-03</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新於</span>
      <time title="修改時間：2023-03-04 22:27:16" itemprop="dateModified" datetime="2023-03-04T22:27:16+08:00">2023-03-04</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>本範例使用 Ubuntu Server 20.04 </p>
<p>安裝大略分為下列幾個步驟：</p>
<ol>
<li>安裝 Ubuntu Server</li>
<li>安裝 Docker </li>
<li>安裝與設定 OpenVPN</li>
</ol>
<h1 id="安裝-Ubuntu-Server"><a href="#安裝-Ubuntu-Server" class="headerlink" title="安裝 Ubuntu Server"></a>安裝 Ubuntu Server</h1><p>網路上有一堆教學，其實一直下一步基本上也是沒啥問題啦 (?</p>
<h1 id="安裝-Docker"><a href="#安裝-Docker" class="headerlink" title="安裝 Docker"></a>安裝 Docker</h1><p>執行 <code>curl -sSL https://get.docker.com | sudo sh</code> 讓腳本幫你搞定安裝程序</p>
<p>安裝完成以後執行 <code>sudo usermod -aG docker &lt;你的使用者名稱&gt;</code> ，例如 <code>sudo usermod -aG docker ikaros</code> 這樣</p>
<p>這會給你的帳號使用 Docker 的權限，如果沒有做這行就只有最高權限的 <code>root</code> 帳號可以使用 Docker</p>
<p>做完以後記得登入再重新登入，才會套用新的權限設定 (把連線視窗關掉再連一次就可以)</p>
<h1 id="安裝與設定-OpenVPN"><a href="#安裝與設定-OpenVPN" class="headerlink" title="安裝與設定 OpenVPN"></a>安裝與設定 OpenVPN</h1><p>這次使用人家打包好的 OpenVPN，設定起來非常簡便，詳細資料可以參考 <a target="_blank" rel="noopener" href="https://hub.docker.com/r/kylemanna/openvpn">連結</a></p>
<ol>
<li><p>先將存放資料的 Docker volume 名稱寫入環境變數，方便後面使用<br>執行 <code>echo &#39;export OVPN_DATA=&quot;ovpn-data-example&quot;&#39; &gt;&gt; ~/.bashrc</code><br>接著執行 <code>source ~/.bashrc</code> 重新載入環境變數</p>
</li>
<li><p>建立存放 OpenVPN 資料用的 Docker volume<br>執行 <code>docker volume create --name $OVPN_DATA</code></p>
</li>
<li><p>執行 OpenVPN 的初始設定腳本<br>執行 <code>docker run -v $OVPN_DATA:/etc/openvpn --rm kylemanna/openvpn ovpn_genconfig -u udp://VPN.SERVERNAME.COM</code> ，記得把後面的 <code>VPN.SERVERNAME.COM</code> 換成你自己的 domain</p>
</li>
<li><p>執行 OpenVPN 的初始設定腳本 趴兔<br>執行 <code>docker run -v $OVPN_DATA:/etc/openvpn --rm -it kylemanna/openvpn ovpn_initpki</code></p>
</li>
</ol>
<p>在跑腳本過程中會出現 <code>Enter New CA Key Passphrase:</code> 的字樣，是要你設定一組憑證的密碼，務必牢記，在新增使用者時會用到</p>
<p>腳本詢問 <code>Common Name</code> 時可以直接按 Enter 使用預設值</p>
<p>在遇到 <code>Enter pass phrase for /etc/openvpn/pki/private/ca.key</code> 時就是要你輸入剛剛憑證的密碼了</p>
<p>這個步驟完整做完大約會長這樣：<br><img src="/2022/09/02/OpenVPN-%E6%87%B6%E4%BA%BA%E5%AE%89%E8%A3%9D%E6%B3%95/2022032601-Openvpn-install-initpki.png" alt="Console 畫面截圖" loading="lazy"></p>
<ol start="5">
<li>啟動 OpenVPN 伺服器<br>執行 <code>docker run -v $OVPN_DATA:/etc/openvpn -d -p 1194:1194/udp --cap-add=NET_ADMIN --restart=unless-stopped --name openvpn kylemanna/openvpn</code></li>
</ol>
<p>因為加了 <code>--restart=unless-stopped</code> 參數，之後重新開機也會自動執行</p>
<ol start="6">
<li><p>新增 OpenVPN 使用者<br>執行 <code>docker run -v $OVPN_DATA:/etc/openvpn --rm -it kylemanna/openvpn easyrsa build-client-full CLIENTNAME nopass</code>，記得將 <code>CLIENTNAME</code> 換成你想要的使用者名稱</p>
</li>
<li><p>取得使用者用的 OpenVPN 設定檔<br>執行 <code>docker run -v $OVPN_DATA:/etc/openvpn --rm kylemanna/openvpn ovpn_getclient CLIENTNAME &gt; CLIENTNAME.ovpn</code>，記得將兩個 <code>CLIENTNAME</code> 都換成剛剛新增 OpenVPN 使用者的名稱<br>接著執行 <code>cat CLIENTNAME.ovpn</code> 印出設定檔的內容，全部複製下來 copy 到自己電腦就可以，或是用 <code>scp</code> 之類的工具 copy 到自己電腦也可以</p>
</li>
</ol>
<p>執行完以上步驟以後就可以用 OpenVPN Client 之類的工具連線了</p>
<p>產生出來的設定檔應該會像下面那樣：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">client</span><br><span class="line">nobind</span><br><span class="line">dev tun</span><br><span class="line">remote-cert-tls server</span><br><span class="line"></span><br><span class="line">remote 你的網址 1194 udp</span><br><span class="line"></span><br><span class="line">&lt;key&gt;</span><br><span class="line">-----BEGIN PRIVATE KEY-----</span><br><span class="line">長長的 key ...</span><br><span class="line">-----END PRIVATE KEY-----</span><br><span class="line">&lt;/key&gt;</span><br><span class="line">&lt;cert&gt;</span><br><span class="line">-----BEGIN CERTIFICATE-----</span><br><span class="line">長長的憑證 ...</span><br><span class="line">-----END CERTIFICATE-----</span><br><span class="line">&lt;/cert&gt;</span><br><span class="line">&lt;ca&gt;</span><br><span class="line">-----BEGIN CERTIFICATE-----</span><br><span class="line">長長的憑證 ...</span><br><span class="line">-----END CERTIFICATE-----</span><br><span class="line">&lt;/ca&gt;</span><br><span class="line">key-direction 1</span><br><span class="line">&lt;tls-auth&gt;</span><br><span class="line">#</span><br><span class="line"># 2048 bit OpenVPN static key</span><br><span class="line">#</span><br><span class="line">-----BEGIN OpenVPN Static key V1-----</span><br><span class="line">長長的 key ...</span><br><span class="line">-----END OpenVPN Static key V1-----</span><br><span class="line">&lt;/tls-auth&gt;</span><br><span class="line"></span><br><span class="line">redirect-gateway def1</span><br></pre></td></tr></table></figure>

<p>如果機器前面有防火牆之類的話要記得開 UDP 1194 port，並將 UDP 1194 port 轉發到開 OpenVPN 的機器</p>
<h1 id="一些額外指令"><a href="#一些額外指令" class="headerlink" title="一些額外指令"></a>一些額外指令</h1><ul>
<li>關閉 OpenVPN Server<br><code>docker stop openvpn</code></li>
<li>重啟 OpenVPN Server<br><code>docker restart openvpn</code></li>
<li>檢視 OpenVPN Server 的記錄檔<br><code>docker logs -f openvpn</code></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://blog.yeekaros.net/2022/09/02/AWS-VPC-%E8%A8%AD%E5%AE%9A%E7%AD%86%E8%A8%98/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="YEEKaros">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="爆頭的隨手記">
      <meta itemprop="description" content="一個肥宅工程師的碎碎念">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 爆頭的隨手記">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/09/02/AWS-VPC-%E8%A8%AD%E5%AE%9A%E7%AD%86%E8%A8%98/" class="post-title-link" itemprop="url">AWS VPC 設定筆記</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">發表於</span>

      <time title="創建時間：2022-09-02 19:38:02" itemprop="dateCreated datePublished" datetime="2022-09-02T19:38:02+08:00">2022-09-02</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新於</span>
      <time title="修改時間：2023-03-04 22:27:16" itemprop="dateModified" datetime="2023-03-04T22:27:16+08:00">2023-03-04</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="緣起"><a href="#緣起" class="headerlink" title="緣起"></a>緣起</h1><p>AWS VPC 在管理複雜的網路設置時確實是個強大的工具，對於我這種喜歡把東西分門別類放得很漂亮，就連機器也不放過的人來說規劃實作起來真的很爽，不過也因為設定實在太細了，一段時間沒做又因為專案需求需要實作時就會漏東漏西，那就來寫一篇筆記給未來的自己當作參考吧。</p>
<p><del>我才不會說是因為自己多犯了好幾個蠢，多 debug 了 3 小時才來寫筆記勒</del></p>
<h1 id="情境"><a href="#情境" class="headerlink" title="情境"></a>情境</h1><p>本次預計實作的架構如下：</p>
<ol>
<li>VPC 使用網段 10.9.0.0&#x2F;16</li>
<li>subnet 一共 6 個，每個都拿一段 &#x2F;24，分為 ELB 用 2 個 + EC2 用 2 個 + RDS 用 2 個，每個都要在不同 AZ (為了每個服務都可以開 HA)</li>
<li>Security Group 一共 3 個，分別給 ELB (HTTP + HTTPS)、EC2 (HTTP + SSH)、RDS (PostgreSQL) 用</li>
</ol>
<h1 id="設定步驟"><a href="#設定步驟" class="headerlink" title="設定步驟"></a>設定步驟</h1><p>好啦，規劃好了就可以開始設定了</p>
<h2 id="1-新增-VPC"><a href="#1-新增-VPC" class="headerlink" title="1. 新增 VPC"></a>1. 新增 VPC</h2><p>有需要 IPv6 的話記得在 <code>IPv6 CIDR block</code> 選 <code>Amazon-provided IPv6 CIDR block</code>，不然選 <code>No IPv6 CIDR block</code> 的話就是 IPv4 only 了</p>
<p>我個人習慣用 <code>專案名稱-環境名稱 (production / staging)</code> 來當 VPC 的名稱</p>
<h2 id="2-修改-VPC-的-DNS-相關設定"><a href="#2-修改-VPC-的-DNS-相關設定" class="headerlink" title="2. 修改 VPC 的 DNS 相關設定"></a>2. 修改 VPC 的 DNS 相關設定</h2><p>選擇單個 VPC 以後在 </p>
<ul>
<li>Actions -&gt; <code>Edit DNS hostnames</code> </li>
<li>Actions -&gt; <code>Edit DNS resolution</code></li>
</ul>
<p>兩項裡面分別把功能啟用</p>
<p>從 <a target="_blank" rel="noopener" href="https://docs.aws.amazon.com/vpc/latest/userguide/vpc-dns.html">AWS 的文件</a> 來看，<code>DNS resolution</code> 的設定是用來開關此 VPC 裡面私有域名的解析 (如 <code>ip-10-9-1-123.ap-northeast-1.compute.internal</code> 這樣的 domain)，同時也影響 AWS 會不會幫你放一台 DNS Server 在你的 VPC 裡面</p>
<p>另外 <code>DNS hostnames</code> 的設定是用來開關在這個 VPC 裡面拿到 public ip 的機器會不會一起拿到一個解析到該 public ip 的 domain (如 <code>ec2-18-123-123-123.ap-northeast-1.compute.amazonaws.com</code> 這樣的 domain)</p>
<p>主要是為了使用 Elastic Beanstalk 來部署應用程式這邊的設定才一定要開，不過為了方便個人是都會開著</p>
<h2 id="3-新增-subnet"><a href="#3-新增-subnet" class="headerlink" title="3. 新增 subnet"></a>3. 新增 subnet</h2><p>記得如果要做 HA 的話，同個服務內的每個 subnet 要放在不同的 AZ，不然假設一個 AZ 炸了你的服務還是照樣炸開。</p>
<p>當然如果你遇上了日本沉沒還是救不了你，不過反正最頭痛的也不會是你 (茶。</p>
<p>個人習慣用 <code>專案名稱-環境名稱-放的服務 (elb / ec2 / rds)-編號 (2位數字)</code> 來命名</p>
<h3 id="特別注意"><a href="#特別注意" class="headerlink" title="特別注意"></a><strong>特別注意</strong></h3><p>這次新踩到的坑，如果你有用 Elastic Beanstalk 來幫你部署 ELB，或是 ELB 的 target 是用 <code>instance</code> 而不是 <code>ip</code> 的話，要注意 ELB 所使用的 subnet 的 AZ 要和 EC2 subnet 的 AZ 一樣或是完全涵蓋<br>(ex: ELB 用 <code>ap-northeast-1a</code> + <code>ap-northeast-1b</code> + <code>ap-northeast-1d</code>，EC2 用 <code>ap-northeast-1a</code> + <code>ap-northeast-1d</code>)</p>
<p>不然在 Target Group 裡你的 target 註冊上去以後狀態會是 <code>unused</code>，說明顯示 <code>Target is in an Availability Zone that is not enabled for the load balancer</code>。實際連線看看的話當然是完全連不到。<br><img src="/2022/09/02/AWS-VPC-%E8%A8%AD%E5%AE%9A%E7%AD%86%E8%A8%98/2021091301-AWSELB.png" loading="lazy"></p>
<h2 id="4-修改-subnet-設定"><a href="#4-修改-subnet-設定" class="headerlink" title="4. 修改 subnet 設定"></a>4. 修改 subnet 設定</h2><p>如果你希望這個 subnet 的機器都自動拿到一個 public ip，可以在 Actions -&gt; <code>Modify auto-assign IP settings</code> 裡面打開他</p>
<h2 id="5-新增-Route-Table"><a href="#5-新增-Route-Table" class="headerlink" title="5. 新增 Route Table"></a>5. 新增 Route Table</h2><h2 id="6-新增-Internet-Gateway-並-attach-到-VPC"><a href="#6-新增-Internet-Gateway-並-attach-到-VPC" class="headerlink" title="6. 新增 Internet Gateway 並 attach 到 VPC"></a>6. 新增 Internet Gateway 並 attach 到 VPC</h2><h2 id="7-新增-default-gateway"><a href="#7-新增-default-gateway" class="headerlink" title="7. 新增 default gateway"></a>7. 新增 default gateway</h2><p>在剛剛新增的 Route Table 裡面新增 default gateway (Destination 為 <code>0.0.0.0/0</code>，target 為剛剛新增的 Internet Gateway)</p>
<p>如果你忘了新增又剛好像我一樣直接用了 Elastic Beanstalk 部署的話，那就會產生一個很詭異的情形是部署跑很久都不會成功，想 SSH 進 EC2 機器鳥都不鳥你，那就要想想是不是自己犯蠢了</p>
<h2 id="8-新增-Security-Group-與規則"><a href="#8-新增-Security-Group-與規則" class="headerlink" title="8. 新增 Security Group 與規則"></a>8. 新增 Security Group 與規則</h2><p>除了服務會用到的 port (如 HTTP&#x2F;HTTPS) 以外，要注意允許其他 Security Group 來的連線 (ex: RDS 的 Security Group 要允許 EC2 的 Security Group 來的連線)</p>
<p>如果有直接連入 debug 之類的需求，我習慣會把公司對外的固定 IP 設定成允許直接連入，不過這部分就看你如何拿捏安全性和方便了</p>
<p>個人習慣用 <code>專案名稱-環境名稱-放的服務</code> 來命名</p>
<h2 id="9-新增允許自己連到自己的-Security-Group-的規則"><a href="#9-新增允許自己連到自己的-Security-Group-的規則" class="headerlink" title="9. 新增允許自己連到自己的 Security Group 的規則"></a>9. 新增允許自己連到自己的 Security Group 的規則</h2><p>如果不允許的話在機器上用自己的 public ip 連線到自己會被防火牆擋下來，然後你就會一頭霧水。Elastic Beanstalk 之類的工具遇到這類問題尤其難 debug，他看起來就是莫名不會動</p>
<h1 id="恭喜搞定"><a href="#恭喜搞定" class="headerlink" title="恭喜搞定"></a>恭喜搞定</h1><p>好了，設定大致上就到這邊結束，恭喜你搞定了網路設定，到了會用這種規模的應用程式，搞定網路以後還有更多問題等著你呢 (?</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://blog.yeekaros.net/2022/09/01/%E5%88%9D%E6%8E%A2-Wireguard/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="YEEKaros">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="爆頭的隨手記">
      <meta itemprop="description" content="一個肥宅工程師的碎碎念">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 爆頭的隨手記">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/09/01/%E5%88%9D%E6%8E%A2-Wireguard/" class="post-title-link" itemprop="url">初探 Wireguard</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">發表於</span>

      <time title="創建時間：2022-09-01 15:41:08" itemprop="dateCreated datePublished" datetime="2022-09-01T15:41:08+08:00">2022-09-01</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新於</span>
      <time title="修改時間：2023-03-04 22:27:16" itemprop="dateModified" datetime="2023-03-04T22:27:16+08:00">2023-03-04</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="緣起"><a href="#緣起" class="headerlink" title="緣起"></a>緣起</h1><p>因為最近整理 E-Hentai 上的 favorite 時發現有部分的收藏吃了版權砲，索性開始把有收藏過的本子和喜歡的畫師都抓一份下來，反正收本子也花不了多少硬碟空間。</p>
<p>看漫畫的部分我習慣使用 iOS 上的 <a target="_blank" rel="noopener" href="https://apps.apple.com/tw/app/comicglass-comicreader/id363992049">ComicGlass</a>，除了將檔案放在本機，同時也支援從 SMB 協定開檔案或是使用自家的 <a target="_blank" rel="noopener" href="http://comicglass.net/download/toolsdownload/">MediaServer</a>。雖然之前使用 MediaServer 的體驗很好，但它得跑在 Windows &#x2F; Mac 上，要開一台 VM 跑 Windows 實在太浪費資源了，於是便考慮架個 VPN 連回家裡的 NAS 用 SMB 開漫畫來看了。</p>
<p>要架 VPN 原先第一想到的是 <a target="_blank" rel="noopener" href="https://openvpn.net/">OpenVPN</a>，但是在 RouterOS 上胡搞瞎搞一番以後連線總是有問題 (主要都是憑證問題)，在 RouterOS 上同時要使用帳號密碼 + 憑證的驗證方式實在麻煩，就在隨意翻翻 <a target="_blank" rel="noopener" href="https://github.com/awesome-selfhosted/awesome-selfhosted">Awesome-Selfhosted</a> 時想起了還有 Wireguard 這個看了很久但一直沒玩過的酷玩具，就在這次來試試看吧。</p>
<h1 id="環境"><a href="#環境" class="headerlink" title="環境"></a>環境</h1><p>本次使用的環境是架在 Proxmox VE 上的 Alpine Linux 3.14，使用的是 <code>alpine-virt-3.14.2-x86_64</code> 這個版本</p>
<p>目標是讓 VPN 可以使用一個自己的網段 <code>192.168.6.0/24</code> 來與原先的內網 <code>192.168.2.0/24</code> 通訊，同時可以連上 Internet</p>
<h1 id="實作"><a href="#實作" class="headerlink" title="實作"></a>實作</h1><p>恭喜你看完了前面的廢話，Wireguard 的實作實在是簡易到讓人懷疑他是不是 VPN 的程度，就讓我們快速地開始吧。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">根據 Alpine Linux Wiki 進行安裝</span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">https://wiki.alpinelinux.org/wiki/Configure_a_Wireguard_interface_(wg)</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">安裝 Wireguard 管理工具包</span></span><br><span class="line">apk add wireguard-tools</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">載入 Wireguard 模組</span></span><br><span class="line">modprobe wireguard</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">產生 private key 與 public key</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">這邊產生的 key 會做為後面連線認證之用</span></span><br><span class="line">wg genkey | tee privatekey | wg pubkey &gt; publickey</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>安裝完了 Wireguard 與產生 key，接下來就要寫 Wireguard 的設定檔 <code>/etc/wireguard/wg0.conf</code> (<code>wg0</code> 可以替換成自己想要的介面名稱)</p>
<p>這邊簡單分成兩個版本，一個是讓 VPN Client 存取內網時保持 VPN 網段的 IP 的，這個狀況要自己設定好 Routing 的部分。另一個則是做 NAT，讓 VPN Client 存取內網或 Internet 時都會使用 VPN Server 的 IP</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 做 NAT 的版本，如果你不熟網路設定就用這個</span></span><br><span class="line"><span class="section">[Interface]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Address 是 Wireguard 介面用的 ip</span></span><br><span class="line"><span class="attr">Address</span> = <span class="number">192.168</span>.<span class="number">6.1</span>/<span class="number">24</span> </span><br><span class="line"></span><br><span class="line"><span class="comment"># Wireguard server 所監聽的 port</span></span><br><span class="line"><span class="attr">ListenPort</span> = <span class="number">45340</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 在這邊貼上剛剛產生的 private key</span></span><br><span class="line"><span class="attr">PrivateKey</span> = SG1nXk2+kAAKnMkL5aX3NSFPaGjf9SQI/wWwFj9l9U4= </span><br><span class="line"></span><br><span class="line"><span class="attr">PostUp</span> = iptables -A FORWARD -i %i -j ACCEPT<span class="comment">; iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE;iptables -A FORWARD -o %i -j ACCEPT</span></span><br><span class="line"><span class="attr">PostDown</span> = iptables -D FORWARD -i %i -j ACCEPT<span class="comment">; iptables -t nat -D POSTROUTING -o eth0 -j MASQUERADE;iptables -D FORWARD -o %i -j ACCEPT</span></span><br><span class="line"></span><br><span class="line"><span class="attr">DNS</span> = <span class="number">8.8</span>.<span class="number">8.8</span></span><br></pre></td></tr></table></figure>

<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 不做 NAT 的版本，要自己設定和其他網段的 static routing</span></span><br><span class="line"><span class="section">[Interface]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Address 是 Wireguard 介面用的 ip</span></span><br><span class="line"><span class="attr">Address</span> = <span class="number">192.168</span>.<span class="number">6.1</span>/<span class="number">24</span> </span><br><span class="line"></span><br><span class="line"><span class="comment"># Wireguard server 所監聽的 port</span></span><br><span class="line"><span class="attr">ListenPort</span> = <span class="number">45340</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 在這邊貼上剛剛產生的 private key</span></span><br><span class="line"><span class="attr">PrivateKey</span> = SG1nXk2+kAAKnMkL5aX3NSFPaGjf9SQI/wWwFj9l9U4= </span><br><span class="line"></span><br><span class="line"><span class="attr">PostUp</span> = iptables -A FORWARD -i %i -j ACCEPT<span class="comment">;iptables -A FORWARD -o %i -j ACCEPT</span></span><br><span class="line"><span class="attr">PostDown</span> = iptables -D FORWARD -i %i -j ACCEPT<span class="comment">;iptables -D FORWARD -o %i -j ACCEPT</span></span><br><span class="line"></span><br><span class="line"><span class="attr">DNS</span> = <span class="number">8.8</span>.<span class="number">8.8</span></span><br></pre></td></tr></table></figure>

<p><strong>如果採用不做 NAT 的版本的話記得要在你的 Router 上設定 static routing，把  <code>192.168.6.0/24</code> 送到你的 Wireguard server IP</strong></p>
<p>寫好設定檔以後，執行以下指令讓 Wireguard 跑起來</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">如果在上一步驟你不是用 wg0 做為介面名稱，這邊記得要改</span></span><br><span class="line">wg-quick up wg0</span><br></pre></td></tr></table></figure>

<p>如果要把 Wireguard 關掉則反過來是</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wg-quick down wg0</span><br></pre></td></tr></table></figure>

<p>到這邊 server 端的基本設定就完成了，接下來是有關 Client 的設定，在這邊示範的是 Wireguard iOS App</p>
<p>首先在 server 上的設定檔加上以下設定</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[Peer]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 允許這個 Client 使用的網段</span></span><br><span class="line"><span class="attr">AllowedIPs</span> = <span class="number">192.168</span>.<span class="number">6.0</span>/<span class="number">24</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 在 iOS App 上產生出來的 public key</span></span><br><span class="line"><span class="attr">PublicKey</span> = QNZxoNgtUF/rFW+SKm+Qs+w+<span class="number">3</span>ywhM+YcUh5GUkhnOWM=</span><br><span class="line"></span><br><span class="line"><span class="comment"># 每幾秒要檢查一次連線是不是還活著，一般來說 10 ~ 15 秒就夠了，預設是 30 秒</span></span><br><span class="line"><span class="attr">PersistentKeepalive</span> = <span class="number">10</span></span><br></pre></td></tr></table></figure>
<p>接著在 iOS App 端設定連線</p>
<p><img src="/2022/09/01/%E5%88%9D%E6%8E%A2-Wireguard/2021110401-WireGuard-iOS.png" loading="lazy"></p>
<p>在 <code>Addresses</code> 裡面填入想要使用的內網 IP，注意要在 server 設定的 <code>AllowedIPs</code> 網段裡面<br>下面的 <code>Public key</code> 填入 server 的 public key<br><code>Endpoint</code> 填入 server 的 ip 和 Wireguard 的 port<br><code>Allowed IPs</code> 在這邊是要填入要經由 Wireguard VPN 連線的網段，如果你要全部流量都經由 VPN 出去的話就填 <code>0.0.0.0/0</code></p>
<p>到這邊就設定完成，可以試著連線看看了。<br>連線成功的話 Client 端會顯示有流量在跑</p>
<p><img src="/2022/09/01/%E5%88%9D%E6%8E%A2-Wireguard/2021110402-WireGuard-iOS.png" loading="lazy"></p>
<p>server 端則可以用 <code>wg</code> 指令來觀察 Client 有沒有在動</p>
<p><img src="/2022/09/01/%E5%88%9D%E6%8E%A2-Wireguard/2021110403-WireGuard-serer.png" loading="lazy"></p>
<p>到這邊基本就會動了，後續再來看看穩定性和效能表現如何</p>
<h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><ul>
<li><a target="_blank" rel="noopener" href="https://wiki.alpinelinux.org/wiki/Configure_a_Wireguard_interface_(wg)">Alpine Linux Wiki</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/wgredlong/WireGuard/blob/master/2.%E7%94%A8%20wg-quick%20%E8%B0%83%E7%94%A8%20wg0.conf%20%E7%AE%A1%E7%90%86%20WireGuard.md">wgredlong&#x2F;WireGuard</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/awesome-selfhosted">awesome-selfhosted</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>





</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">YEEKaros</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a> 強力驅動
  </div>

    </div>
  </footer>

  
  <div class="back-to-top" role="button" aria-label="回到頂端">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  




  





</body>
</html>
